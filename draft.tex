\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{url}
\usepackage{hyperref}
\usepackage{xcolor}
\newcommand{\code}{\texttt}
\usepackage[
backend=biber,
style=alphabetic,
sorting=ynt
]{biblatex}
\addbibresource{bibliography.bib}
\usepackage{amsmath}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}
\usepackage{algorithm}% http://ctan.org/pkg/algorithms 
\usepackage{algpseudocode}% http://ctan.org/pkg/algorithmicx 
\newcommand{\var}[1]{{\ttfamily#1}}% variable 

\title{Evolutionary market ecologies \\ Model \& Numerical experiments}
\author{Aymeric Vi\'{e}}
\date{\today}

\begin{document}

\maketitle

\tableofcontents

\clearpage

\section{Trend following Model description}

\subsection{Initialisation}

We first create a population of $n$ trend-following agents, at time $t=0$. Each agent $i$ is described by its strategy $\theta_i(0)$, initial cash $C_i(0)$, initial assets $S_i(0)$. The $\theta$ parameter describes the time horizon on which the trend following strategy is based (Equation \ref{trend_following_equation}). Initial strategies are drawn uniformly in $[2,H]$, where $H$ is the maximum possible time horizon. \par
Values for initial endowments of the agents meet the $\$100M$ Securities and Exchange Commission threshold for institutional investment managers, that are equally split in cash and asset shares. 

\subsection{Market structure}

In this market, agents are choosing between a bond with a fixed continuously paid interest rate $r = 1\%$ annually, and an asset which pays dividends $D(t)$ at each step $t$, modelled as an autocorrelated geometric Brownian Motion.

\begin{equation}
    \label{dividend_equation}
    \begin{array}{l}
{D}(t)={D}(t)+g {D}(t-1)+\sigma {D}(t-1) {U}(t), \\
{U}(t)=\omega U(t-2)+\left(1-\omega^{2}\right){Z}(t)
\end{array}
\end{equation}

Where $g$ is the dividend growth rate, $\sigma$ its variance, $\omega$ is the autocorrelation parameter of the process, and $Z$ is a standard Wiener process. Based on estimates from Lebaron \cite{lebaron2001empirical} and Scholl et al. \cite{scholl2020market}, we take $g=2\%$ annually and $\sigma = 6\%$ annually. \par
The market is initialised with an initial price of $100$ that matches the fundamental value of the asset, and initial dividends of $100$. 

\subsection{Strategy and market behavior}
At each time period, trend followers look at past prices to decide the content of their next portfolio, choosing between cash and an asset. The share of their wealth that will be devoted to asset shares is proportional to the agent trading signal $\phi(t)$. Here, the agent compares the logarithm of the prices at last period, and at another period $\theta$. This $\theta$ is the time horizon of this agent's trend following strategy, and is subject to evolution. We consider $\theta \in (1, H]$ with $H$ the maximum allowed time horizon. In \cite{scholl2020market}, trend followers all had $\theta = 2$; this generalisation allows us to look at a larger space of strategies.
% here we write what the agents do, trading signal (write an example with a time series and a few different agents? that would be very nice. Inspire from David's figure 1?), excess demand, market clearing
% mention the next strategy extensions
% mention hypermutation & replacement

\begin{equation}
    \label{trend_following_equation}
    \phi_i(t) = \log_2 p(t-1) - \log_2 p(t-\theta_i)
\end{equation}

Once the trading signals have been updated, the agents express their excess demand for the asset, as shown in Equation \ref{excess_demand_equation}. 

\begin{equation}
\label{excess_demand_equation}
   E_i(t, p(t)) = \frac{W_i(t) {\lambda_i}}{p(t)} \left( \tanh{({c} \phi_i(t)}) + \frac{1}{2} \right) - S_i(t)
\end{equation}

The use of $\tanh$ ensures that the function is bounded and differentiable, for the use of the market clearing algorithm. $c$ denotes the aggressiveness of the agent strategic response, i.e. how much its demand is sensitive to the trading signal. $\lambda$ is the agent leverage. The term $\frac{1}{2}$ ensures that when the agent is indifferent to assets (i.e. when $\phi(t) = 0$), then the agent equally splits its wealth into cash and asset shares.

Agent $i$'s wealth $W_i(t)$ evaluated at time $t$ is computed with:
\begin{equation}
    W_i(t) = C_i(t) + S_i(t)p(t) - L_i(t)
\end{equation}
 
\subsection{Market clearing}

Once all agents have formulated their excess demand functions as a function of the unknown current price $p(t)$, we use Walrasian market clearing to identify the clearing price, as described in \cite{scholl2020market}. In short, excess demands of all agents $a$ in the population $ \mathcal{A}$ are submitted to a price maker agent who attempts to find the root of the aggregate demand, i.e. the price such that the aggregate excess demand is equal to 0.

\begin{equation}
\label{market_clearing_root}
\sum_{a \in \mathcal{A}} E_{a}(p)=0
\end{equation}

If such root does not exist, the price maker instead minimises the mismatch between supply and demand, under the constraint that $p$ is finite.

\begin{equation}
\label{market_clearing_mismatch}
\min_p\left(\sum_{a \in, \mathcal{A}} E_{a}(p)\right)^{2}
\end{equation}

This process allows to pin down the clearing price $p^* = p(t+1)$. We can thus compute the realised demands of the agents, update their asset shares ownership, wealth and profit. The agents receive dividends $D(t)$ in proportion of their asset shares, receive interest $r$ on their cash. Finally, investment inflows and outflows are modelled by the reinvestment parameter $f$, which is the multiplier of the agent profit, i.e. $W(t+1) - W(t)$. For $f > 1$, profits cause an inflow in capital. When $f < 1$, profits cause investors to withdraw funds from the agent-fund; finally, when $f=1$, no particular reinvestment dynamic occurs. \\

Once the clearing price $p^* = \argmin \left(\sum_{a \in, \mathcal{A}} E_{a}(p)\right)^{2} $ has been determined, we update the inventories of the agents.
First, the number of asset shares the agents own is determined as:

\begin{equation}
    S_i(t+1) = E_i(t, p^*) + S_i(t)
\end{equation}

In general, the fixed supply constraint should hold for any $t$:

\begin{equation}
    \sum_i S_i(t) = Q
\end{equation}

The new cash is:

\begin{equation}
    C(t+1) = C(t) - (S(t+1) - S(t))p(t+1) - L(t+1) + L(t)
\end{equation}

\textbf{Margin}

When the agent enters into a short position (i.e. $S(t+1) = E(t,p(t+1)) - S(t) < 0$ , it sells asset shares that it does not own. Its cash grows by $p(t+1)S(t+1)$, but the agent enters into debt, as it must buy later $S(t+1)$ assets to return them to the lender.

\textcolor{red}{WFF}

% In order to guarantee that the short-selling fund can
% return the borrowed securities to the lender at a later time, the fund
% sets aside a margin amount M equal to the current market value
% of the borrowings, in the form of cash.

% - Why the current values? Would it make sense for the agent to remember that it must return S securities, regardless of their price?
% - If the margin amount is set aside in the form of cash, Cash increases by $p(t+1)E(t,p(t+1))$ but decreases by $p(t+1)E(t,p(t+1))$ to fuel the Margin, hence no benefit was done? (unless we automatically return the borrowed assets in the next period at a lower price?)
% - How is returning borrowed securities handled? Does this happen automatically at the next period after short selling? Related question: as Margin does not appear in the wealth equation, how is it impacting the agent?

% Debt is taken on when using leverage > 1 or leverage < -1. For long positions S(t) > 0 and we have L(t) = max(0, -(W(t-1) - S(t)p(t))). For short positions S(t) < 0, we have L(t) = max(0, -(W(t-1) + S(t)p(t))). From this, we should be able to buy W/p units without borrowing, and when short-selling we are restricted to short sell at most W/p units without borrowing. This is restricting the usage of the cash obtained from short-selling for something else (should we for example introduce more assets, we can not use the new cash to buy many other assets without violating leverage constraints).

% Margin M(t)  is something for the balance sheet only, it tracks the current value of the debt min(0, S(t))p(t). When you create the short position at time t, you sell some amount of stock for cash. This increases the pile of cash (see equation for C(t+1)), but it increases L(t) at the same time. Thus it would cancel out in the wealth equation. 

\begin{table}[]
    \centering
    \begin{tabular}{c|c|c}
    Mathematical notation & Meaning & Value \\
    \hline
        $n$ & Number of agents & 100 \\
        $t$ & Time index & $[1,T]$\\
        $T$ & Maximum time index & $[1000;100,000]$\\
        $\theta_i(t)$ & Agent strategy at time $t$ & $(1, H]$\\
        $C_i(0)$ & Initial cash & 50,000,000 \\
        $S_i(0)$ & Initial asset shares & 500,000 \\
        $D(t)$ & Dividend per asset share & See equation \ref{dividend_equation} \\
        $g$ & Dividend growth rate & $0.02$ annually \\
        $\sigma$ & Dividend variance & $0.06$ annually \\
        $\omega$ & Dividend autocorrelation & $0.1$ \\
        $c$ & Strategy aggressiveness & $[1,10]$ \\
        $\lambda$ & Agent leverage & $[1,10]$ \\
        $f$ & Reinvestment rate & $[0,2]$ \\
        $\tau$ & Tournament size & $(1,n]$ \\
        $\nu$ & EMA length & $[1,2520]$ \\
        $\rho$ & Crossover rate & $[0,1]$ \\
        $\mu$ & Mutation rate & $[0,1]$ \\
        $\varsigma$ & Selection rate & $\{0,1\}$
    \end{tabular}
    \caption{Parameters and notations}
    \label{parameters_correspondence}
\end{table}
% some here are not parameters, and will have to be removed

\subsection{Evolution of strategies}
The main contribution of this model is to emphasise the evolution of strategies. This models funds, managers, who look at the profits and performance of other funds, and tend to imperfectly imitate stronger financial strategies. Each fund can also independently choose to marginally change its strategy, in an exploratory behavior. First, insolvent funds cannot influence the evolution of others, and are withdrawn from the market with the \textit{hypermutation} operator. Then, during \textit{selection}, funds choose some other funds to compare their profits and strategy with. \textit{Fitness} defines the objective used for this comparison. Combining the strategy of the best observed fund with theirs happens during \textit{crossover}. Finally, \textit{mutation} allows funds to slightly adjust their strategy as small exploratory jumps.\\
% some refs needed here to support that this behavior exists and is well documented

\paragraph{Hypermutation} First, we implement an \textit{hypermutation} operator in which insolvent agents are removed from the populations. Agents with wealth $W \leq 0$ disappear from the market, and are replaced by new individuals with random strategies and usual initial endowments.

The \textit{fitness} variable looked at for imitation is the exponential moving average of profits $\eta(t)$. For an agent $i$ with current profit $\pi_i(t)$:

\begin{equation}
    \eta_i(t) =  \frac{2}{ \nu + 1} \left(\pi_i(t) -  \eta_i(t-1)\right) +  \eta_i(t-1)
\end{equation}

Where $\nu$ represents the length of the EMA, i.e. the number of day considered. Typical examples of EMAs are 10-day, 50-day or 200-day moving averages. Here, $\nu$ encodes a $\nu$-day EMA for profits. $2$ is chosen as an arbitrary smoothing factor.\\

\paragraph{Selection} In this model, this imitation and exploration behavior are modeled using a genetic algorithm. We first operate a modified tournament \textit{selection} with probability $\varsigma$, the step in which each fund selects a few funds it will compare itself to. The number of selected funds in this tournament is equal to the tournament size $\tau$, set by default to 3. The $\tau$ randomly drawn funds are compared, and the one with the highest fitness is selected. The closer $\tau$ is to the population size $n$, the more reliable the tournament selection outputs the best performing strategy. For each agent $i$ in the population, a tournament selection is operated, and this agent $i$ will imitate the strategy $\theta$ of the highest fitness individual in this tournament.\\

\paragraph{Crossover} Once imitation by tournament selection is operated, we allow strategies to recombine together and explore alternative regions of the strategy space with probability $\rho$. This is the \textit{crossover} operator. In the population, pairs of individuals are gathered, such that each individual is the member of a single pair. For a pair with individuals $A$ and $B$ with respective strategies $^\theta_A$ and $\theta_B$, the resulting individuals $A'$ and $B'$ from the crossover operator are characterised by strategies:

\begin{equation}
    \theta_A' \sim \mathcal{U}([\min(\theta_A; \theta_B), \max(\theta_A; \theta_B)] 
\end{equation}
\begin{equation}
    \theta_B' \sim \mathcal{U}([\min(\theta_A; \theta_B), \max(\theta_A; \theta_B)] 
\end{equation}

In other words, the resulting strategies from the crossover of $A$ and $B$ are uniformly drawn in the space of strategies bounded by the strategies of $A$ and $B$. If $A$ and $B$ had strategies $2$ and $4$, the possible integer strategies resulting from crossover would be $2, 3$ and $4$. For instance, $5$ would not be possible, as it lays outside of the space of strategies covered by the pair ($A,B$).\\

\paragraph{Mutation} Finally, marginal exploration behavior is allowed by the \textit{mutation} operator. With probability $\mu$, the strategy $\theta$ of the agent changes by $+1$ or $-1$, with equal probabilities. The mutation operator is constrained such that the mutated strategy stays within the feasible strategies $[2, H]$. 

% need a table to summarise the operators, their effects and parameters involved
% add pseudocode?


\subsection{Extending to multiple strategy types \& assets}
% with value investors and noise traders
% and mutliple assets

\section{Numerical experiment: identifying the impact of evolution in market dynamics}
% comparison between evolution and non evolution
% need a clear plan, not necessarily all finished, but at least for what's unclear (how many repetitions? How many agents?), some ideas to clear this out.


% Necessary condition: running GA with complete market structure
% To implement:
% \begin{itemize}
%     \item Observe market dynamics over time (easy): price, returns, assets, volatility, dividends, profits
%     \item Observe ecology dynamics over time (hard): proportions? heatmap? Add entropy?
%     Perhaps H (for max time horizon) plots with clear color codes (like jet) over time, and hopefully we see something clear happen.
%     \item Develop a GUI or something nice/updating itself over time to observe that?
% \end{itemize}

% \section{Trend follower market ecology}

% Necessary condition: a running GA with a single asset, market clearing, and adequate starting conditions, and the baseline configuration.


The non-lerning case (replacement dynamics only) can be illustrated with:
\begin{itemize}
    \item No selection (selection rate equal to 0)
    \item No crossover (crossover rate equal to 0)
    \item No mutation (mutation rate equal to 0)
\end{itemize}
The objective is to assess the behavior of the model in this no-learning setup, establish a benchmark.

Then, we can introduce learning at different degrees, and channels. Learning requires activation of selection.

\begin{enumerate}
    \item Mutation alone, with different values
    \item Crossover alone, with different values
    \item Mutation and crossover
\end{enumerate}

How does learning affect market dynamics? Ecology dynamics?

There are many many things we can also study just with trend followers:
\begin{itemize}
    \item Influence of strategy space with H
    \item Time horizon of EMA fitness profit
    \item Market parameters: dividend growth rate, volatility, interest rate, autocorrelation
    \item Alternative values for agent leverage, aggressiveness of response 
    \item Population size
    \item Tournament size
    \item Reinvestment rate
\end{itemize}

The key area of progress will be to add multiple strategy types, this may require a lot of work on the structure. 3 separate GAs with fixed population sizes? dynamic population sizes?

\printbibliography

\end{document}